# Docker-in-Docker æ§‹æˆã¸ã®ç§»è¡Œå®Œäº† âœ…

## ğŸ¯ å¤‰æ›´å†…å®¹

**å•é¡Œ:** Docker Composeã‚’ä½¿ã£ãŸè¤‡æ•°ã‚µãƒ¼ãƒ“ã‚¹æ§‹æˆãŒCodespacesã§å‹•ä½œã—ãªã„

**è§£æ±º:** Docker-in-Dockerã‚’ä½¿ç”¨ã—ã¦Codespaceå†…ã§SQL Serverã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•

## ğŸ“‹ å®Ÿè£…ã—ãŸå¤‰æ›´

### 1. devcontainer.json
- âŒ å‰Šé™¤: `dockerComposeFile`, `service`, `runServices`
- âœ… è¿½åŠ : `features.docker-in-docker` (Dockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§Dockerã‚’å®Ÿè¡Œå¯èƒ½ã«)
- âœ… å¤‰æ›´: `postCreateCommand` ã§ `start-mssql.sh` ã‚’å®Ÿè¡Œ

### 2. æ–°è¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆ: start-mssql.sh
SQL Serverã‚³ãƒ³ãƒ†ãƒŠã‚’è‡ªå‹•èµ·å‹•:
- Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³ã®æº–å‚™å®Œäº†ã‚’å¾…æ©Ÿ
- `mssql` ã‚³ãƒ³ãƒ†ãƒŠã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
- å­˜åœ¨ã—ãªã‘ã‚Œã°æ–°è¦ä½œæˆã€å­˜åœ¨ã™ã‚Œã°èµ·å‹•
- SQL Serverã®æº–å‚™å®Œäº†ã‚’ç¢ºèªï¼ˆ60ç§’ãƒªãƒˆãƒ©ã‚¤ï¼‰

### 3. init-db.sh ã®æ›´æ–°
- âŒ å‰Šé™¤: `mssql` ãƒ›ã‚¹ãƒˆåã®è§£æ±ºãƒã‚§ãƒƒã‚¯
- âœ… å¤‰æ›´: `localhost` ã¸ã®æ¥ç¶šã«å¤‰æ›´
- âœ… æ”¹å–„: ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

### 4. manual-init.sh ã®æ›´æ–°
- âœ… è¿½åŠ : mssqlã‚³ãƒ³ãƒ†ãƒŠã®è‡ªå‹•èµ·å‹•æ©Ÿèƒ½
- âœ… å¤‰æ›´: `localhost` æ¥ç¶šã«å¯¾å¿œ

### 5. ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ›´æ–°
- [CODESPACE_SETUP.md](../CODESPACE_SETUP.md): Docker-in-Dockeræ§‹æˆã®èª¬æ˜ã‚’è¿½åŠ 
- ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å…¨é¢åˆ·æ–°

## ğŸš€ å‹•ä½œãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[Codespaceèµ·å‹•] --> B[Dev Containerãƒ“ãƒ«ãƒ‰]
    B --> C[Docker-in-Dockeræ©Ÿèƒ½ã‚’æœ‰åŠ¹åŒ–]
    C --> D[postCreateCommandå®Ÿè¡Œ]
    D --> E[check-secrets.sh]
    E --> F[start-mssql.sh]
    F --> G[SQL Serverã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•]
    G --> H[postStartCommandå®Ÿè¡Œ]
    H --> I[init-db.sh]
    I --> J[ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–]
    J --> K[é–‹ç™ºç’°å¢ƒæº–å‚™å®Œäº†âœ…]
```

## ğŸ”§ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     GitHub Codespace (Cloud VM)         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   Dev Container (workspace)       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚   â”‚  Java/Mavenç’°å¢ƒ              â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  sqlcmd ãƒ„ãƒ¼ãƒ«                â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  Spring Boot ã‚¢ãƒ—ãƒª          â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚                                     â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚   â”‚  Docker Daemon (DinD)       â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  â”‚ SQL Server Container  â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  â”‚ (mssql)               â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  â”‚ Port: 1433            â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  â”‚ DB: pct901s           â”‚  â”‚ â”‚  â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚ â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ localhost:1433
    Spring Boot â† â†’ SQL Server
```

## âœ… æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

### ä»Šã™ãè©¦ã™

**ç¾åœ¨ã®Codespaceã§è©¦ã™:**
```bash
# SQL Serverã‚’æ‰‹å‹•èµ·å‹•
bash .devcontainer/start-mssql.sh

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–
bash .devcontainer/manual-init.sh

# ç¢ºèª
docker ps
sqlcmd -S localhost -U SA -P "$MSSQL_SA_PASSWORD" -Q "SELECT name FROM sys.databases;"
```

**æ¨å¥¨: Codespaceã‚’å†ãƒ“ãƒ«ãƒ‰**
```
Cmd/Ctrl + Shift + P â†’ "Dev Containers: Rebuild Container"
```
ã“ã‚Œã«ã‚ˆã‚Šå…¨è‡ªå‹•ã§ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã•ã‚Œã¾ã™ã€‚

## ğŸ“ æ—§æ§‹æˆã¨ã®æ¯”è¼ƒ

| é …ç›® | æ—§æ§‹æˆ (docker-compose) | æ–°æ§‹æˆ (Docker-in-Docker) |
|------|-------------------------|---------------------------|
| **SQL Serverèµ·å‹•** | åˆ¥ã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦èµ·å‹• | ã‚³ãƒ³ãƒ†ãƒŠå†…ã§èµ·å‹• |
| **æ¥ç¶šå…ˆ** | `mssql:1433` | `localhost:1433` |
| **Codespacesã‚µãƒãƒ¼ãƒˆ** | âŒ å‹•ä½œã—ãªã„ | âœ… å‹•ä½œã™ã‚‹ |
| **ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—** | docker-compose.yml | start-mssql.sh |
| **ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯** | devnet (bridge) | ãƒ›ã‚¹ãƒˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ |
| **èµ·å‹•ç¢ºèª** | ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ | ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§ãƒªãƒˆãƒ©ã‚¤ |

## ğŸ› æ—¢çŸ¥ã®åˆ¶é™äº‹é …

1. **ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãªã—**
   - Codespaceå‰Šé™¤æ™‚ã«ãƒ‡ãƒ¼ã‚¿ã‚‚æ¶ˆãˆã‚‹
   - é–‹ç™ºç’°å¢ƒã¨ã—ã¦ã¯å•é¡Œãªã—

2. **ãƒªã‚½ãƒ¼ã‚¹æ¶ˆè²»**
   - Dockerã‚³ãƒ³ãƒ†ãƒŠãŒè¿½åŠ ã®ãƒ¡ãƒ¢ãƒª/CPUã‚’ä½¿ç”¨
   - Codespacesã®ç„¡æ–™æ ã«æ³¨æ„

3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - Docker-in-Dockerã«ã‚ˆã‚‹è‹¥å¹²ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ˜ãƒƒãƒ‰
   - é–‹ç™ºç”¨é€”ã§ã¯å•é¡Œãªã„ãƒ¬ãƒ™ãƒ«

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- [devcontainer.json](devcontainer.json) - Dev Containerè¨­å®š
- [start-mssql.sh](start-mssql.sh) - SQL Serverèµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- [init-db.sh](init-db.sh) - ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- [manual-init.sh](manual-init.sh) - æ‰‹å‹•åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- [CODESPACE_SETUP.md](../CODESPACE_SETUP.md) - ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¬ã‚¤ãƒ‰
